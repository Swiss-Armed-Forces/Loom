apiVersion: skaffold/v4beta11
kind: Config
metadata:
  name: loom

# Production configuration as default at top level
build:
  tagPolicy:
    envTemplate:
      template: "{{.TRAEFIK_IMAGE_VERSION}}"
  local:
    concurrency: 0
    useBuildkit: true
    tryImportMissing: true
  artifacts:
    - image: registry.gitlab.com/swiss-armed-forces/cyber-command/cea/loom/traefik
      context: .
      docker:
        dockerfile: Dockerfile
        buildArgs:
          TRAEFIK_IMAGE_VERSION: "{{.TRAEFIK_IMAGE_VERSION}}"
          DOCKER_REGISTRY: "{{or .CI_DEPENDENCY_PROXY_DIRECT_GROUP_IMAGE_PREFIX \"docker.io\"}}"
        cacheFrom:
          - "registry.gitlab.com/swiss-armed-forces/cyber-command/cea/loom/traefik"
      hooks:
        after:
          - command: ["../cicd/tag_latest.sh"]

manifests:
  helm:
    releases:
      - name: production
        namespace: loom
        chartPath: "{{.TRAEFIK_CHART_PATH}}/traefik"
        valuesFiles:
          - values.yaml

# Minimal profiles - only overrides
profiles:
  - name: dev
    activation:
      - command: dev
    patches:
      # Only patch the release name for dev
      - op: replace
        path: /manifests/helm/releases/0/name
        value: development

  - name: offline
    activation:
      - command: offline
    patches:
      # Patch deploy configuration for offline
      - op: add
        path: /deploy
        value:
          # Extended timeouts for image downloads when running offline, we need to download
          # many container images which can take considerable time depending on network
          # speed and image sizes. This profile extends the status check deadline and tolerates
          # failures during that period to allow sufficient time for all images to be pulled
          # and the stack to become ready.
          statusCheckDeadlineSeconds: 21600  # = 6h
          tolerateFailuresUntilDeadline: true

  - name: prod
    activation:
      - command: prod
      # No patches needed - production is already the default
