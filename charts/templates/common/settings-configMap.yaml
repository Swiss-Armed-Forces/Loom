apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "app.fullname" . }}-settings
  labels:
    {{- include "app.labels.custom" (dict "context" . "component" "") | nindent 4 }}
    app.kubernetes.io/component: monitoring
data:
    # NOTE: Using Helm conditionals to prevent keys with null/empty values from being included
    # in the ConfigMap. This is a workaround for an ArgoCD bug where null values in YAML
    # get converted to empty strings, causing the application to remain perpetually OutOfSync.
    #
    # Bug details: https://github.com/argoproj/argo-cd/issues/15566
    # - ArgoCD converts null values to empty strings during processing
    # - This causes a diff between desired state (null) and live state (key removed)
    # - The conditional approach ensures keys are only included when they have actual values
    #
    # Using 'ne ... nil' to exclude null values while including false booleans and zero values

    ENVIRONMENT: {{ .Values.environment }}
    DOMAIN: {{ .Values.domain }}

    # pipeline
    {{- if ne .Values.pipeline.taskTimeLimitSeconds nil }}
    task_time_limit__seconds: {{ .Values.pipeline.taskTimeLimitSeconds | quote }}
    {{- end }}
    {{- if ne .Values.pipeline.uploaded_files_time_before_hidden nil }}
    uploaded_files_time_before_hidden: {{ .Values.pipeline.uploaded_files_time_before_hidden | quote }}
    {{- end }}
    {{- if ne .Values.pipeline.skip_summarize_while_indexing nil }}
    skip_summarize_while_indexing: {{ .Values.pipeline.skip_summarize_while_indexing | quote }}
    {{- end }}
    {{- if ne .Values.pipeline.skip_translate_while_indexing nil }}
    skip_translate_while_indexing: {{ .Values.pipeline.skip_translate_while_indexing | quote }}
    {{- end }}
    {{- if ne .Values.pipeline.automatic_indexing nil }}
    automatic_indexing: {{ .Values.pipeline.automatic_indexing | quote }}
    {{- end }}
    {{- if ne .Values.pipeline.tika_ocr_languages nil }}
    tika_ocr_languages: {{ .Values.pipeline.tika_ocr_languages | join "," | quote }}
    {{- end }}

    # llm
    {{- if ne .Values.llm.model nil }}
    llm_model: {{ .Values.llm.model }}
    {{- end }}
    {{- if ne .Values.llm.model_embedding nil }}
    llm_model_embedding: {{ .Values.llm.model_embedding }}
    {{- end }}
    {{- if ne .Values.llm.model_tool nil }}
    llm_model_tool: {{ .Values.llm.model_tool }}
    {{- end }}
    {{- if ne .Values.llm.think nil }}
    llm_think: {{ .Values.llm.think | quote }}
    {{- end }}
    {{- if ne .Values.llm.temperature nil }}
    llm_temperature: {{ .Values.llm.temperature | quote }}
    {{- end }}
    {{- if ne .Values.llm.summarize_text_chunk_size nil }}
    llm_summarize_text_chunk_size: {{ .Values.llm.summarize_text_chunk_size | quote  }}
    {{- end }}
    {{- if ne .Values.llm.summarize_text_chunk_overlap nil }}
    llm_summarize_text_chunk_overlap: {{ .Values.llm.summarize_text_chunk_overlap | quote  }}
    {{- end }}
    {{- if ne .Values.llm.embedding_temperature nil }}
    llm_embedding_temperature: {{ .Values.llm.embedding_temperature | quote  }}
    {{- end }}
    {{- if ne .Values.llm.embedding_text_chunk_size nil }}
    llm_embedding_text_chunk_size: {{ .Values.llm.embedding_text_chunk_size | quote  }}
    {{- end }}
    {{- if ne .Values.llm.embedding_text_chunk_overlap nil }}
    llm_embedding_text_chunk_overlap: {{ .Values.llm.embedding_text_chunk_overlap | quote  }}
    {{- end }}
    {{- if ne .Values.llm.rerank_temperature nil }}
    llm_rerank_temperature: {{ .Values.llm.rerank_temperature | quote  }}
    {{- end }}

    # elasticsearch
    {{- if ne .Values.elasticsearch.shardsCount nil }}
    es_number_of_shards: {{ .Values.elasticsearch.shardsCount | quote  }}
    {{- end }}
    {{- if ne .Values.elasticsearch.shardsReplicasCount nil }}
    es_number_of_replicas: {{ .Values.elasticsearch.shardsReplicasCount | quote  }}
    {{- end }}

    # translate
    {{- if ne .Values.translate.timeout nil }}
    translate_timeout: {{ .Values.translate.timeout | quote }}
    {{- end }}

    # hosts
    mongo_db_host: mongodb://{{ include "app.fullname" . }}-mongodb:{{ .Values.mongodb.service.port }}
    es_host: http://{{ include "app.fullname" . }}-elasticsearch:{{ .Values.elasticsearch.service.port }}
    rabbit_mq_management_host: http://guest:guest@{{ include "app.fullname" . }}-rabbit:{{ .Values.rabbit.service.port.http }}
    celery_broker_host: amqp://{{ include "app.fullname" . }}-rabbit:{{ .Values.rabbit.service.port.amqp }}
    celery_backend_host: redis://{{ include "app.fullname" . }}-redis:{{ .Values.redis.service.port }}/0?protocol=3
    redis_cache_host: redis://{{ include "app.fullname" . }}-redis-cache:{{ index .Values "redis-cache" "service" "port" }}/0?protocol=3
    tika_server_host: http://{{ include "app.fullname" . }}-tika:{{ .Values.tika.service.port }}
    rspam_host: http://{{ include "app.fullname" . }}-rspamd:{{ .Values.rspamd.worker.service.port }}
    translate_host: http://{{ .Values.translate.service.externalHost | default (printf "%s-translate" (include "app.fullname" .)) }}:{{ .Values.translate.service.port }}
    ollama_host: http://{{ .Values.ollama.service.externalHost | default (printf "%s-ollama" (include "app.fullname" .)) }}:{{ .Values.ollama.service.port }}
    ollama_tool_host: http://{{ index .Values "ollama-tool" "service" "externalHost" | default (printf "%s-ollama-tool" (include "app.fullname" .)) }}:{{ index .Values "ollama-tool" "service" "port" }}
    api_host: http://{{ include "app.fullname" . }}-api:{{ .Values.api.service.port }}
    ws_host: ws://{{ include "app.fullname" . }}-api:{{ .Values.api.service.port }}
    imap_host: imap://{{ include "app.fullname" . }}-dovecot:{{ .Values.dovecot.service.port.imap }}
    minio_host: {{ include "app.fullname" . }}-minio:{{ .Values.minio.service.port }}
    roundcube_host: http://{{ include "app.fullname" . }}-roundcube:{{ .Values.roundcube.service.port }}
    gotenberg_host: http://{{ include "app.fullname" . }}-gotenberg:{{ .Values.gotenberg.service.port }}

    # flower
    FLOWER_BROKER_API: http://guest:guest@{{ include "app.fullname" . }}-rabbit:{{ .Values.rabbit.service.port.http }}/api/
    FLOWER_ENABLE_EVENTS: "false" # by default enabled on all workers anyways